#!groovy
//Run NGINX docker build
properties([disableConcurrentBuilds()])

pipeline {
	agent {
		label 'docker-agent'
		}
	options {
		buildDiscarder (logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
		timestamps()
	}
	stages {
		stage("Build") {
			steps {
				echo "========= Start Build new NGINX =========="
				//Clean if trash remains 
				catchError (buildResult: 'SUCCESS', stageResult: 'FAILURE') {
					sh 'docker rmi mynginx_first_stable_image'
					sh 'docker rm mynginx_first_stable'
					}
        		//Ignore ERROR with first build 
				catchError (buildResult: 'SUCCESS', stageResult: 'FAILURE') {
					sh 'docker tag mynginx_first mynginx_first_stable_image'
					sh 'docker rmi mynginx_first'
					sh 'docker stop mynginx_first'
					sh 'docker rename mynginx_first mynginx_first_stable'
				}
				dir ('NGINX') {
				sh 'docker build -t mynginx_first .'
				    }
				sh 'docker run --name mynginx_first -d -p 80:80 -t mynginx_first'
				sh 'docker exec mynginx_first wget -O /usr/local/nginx/html/index.html https://raw.githubusercontent.com/MiraD1n/OpsWorks/master/WebProject/index.html'
				//try to comment/uncomments below to test different ways of crashes
				//sh 'docker exec mynginx_first rm /usr/local/nginx/html/index.html'
				sh 'docker exec mynginx_first service nginx start'
			}
		}
        stage("Test"){
            steps {
				echo "========= Start Testing =========="
				script{
					try{
						def code = sh(script: 'curl -sL --connect-timeout 20 --max-time 30 -w "%{http_code}\\n" "http://192.168.0.100/" -o /dev/null', returnStdout: true)
						if (code.trim().equals("200")) {
							echo "Good"
							catchError (buildResult: 'SUCCESS', stageResult: 'FAILURE') {	
								sh 'docker rm mynginx_first_stable'
								sh 'docker rmi mynginx_first_stable_image'
							}
							return						
						} else {
							echo "Not Good"
							sh 'docker stop mynginx_first'//stop bad container
							sh 'docker rm mynginx_first'//del bad container
							sh 'docker rename mynginx_first_stable mynginx_first'//rename back work container
							sh 'docker start mynginx_first'//run work container
							sh 'docker exec mynginx_first service nginx start'//start NGINX
							sh 'docker tag mynginx_first mynginx_first_image_bad'//rename bad image
							sh 'docker tag mynginx_first_stable_image mynginx_first'//rename back work image
							sh 'docker rmi mynginx_first_stable_image'//del old image tag
							sh 'docker rmi mynginx_first_image_bad'//del bad image
							currentBuild.result = 'FAILURE'
							return
						}
					}	
					catch (exc){
						echo "Not Good"
						sh 'docker stop mynginx_first'//stop bad container
						sh 'docker rm mynginx_first'//del bad container
						sh 'docker rename mynginx_first_stable mynginx_first'//rename back work container
						sh 'docker start mynginx_first'//run work container
						sh 'docker exec mynginx_first service nginx start'//start NGINX
						sh 'docker tag mynginx_first mynginx_first_image_bad'//rename bad image 
						sh 'docker tag mynginx_first_stable_image mynginx_first'//rename back work image
						sh 'docker rmi mynginx_first_stable_image'//del old image tag
						sh 'docker rmi mynginx_first_image_bad'//del bad image
						currentBuild.result = 'FAILURE'
						return
					}					
				}
            }
        }
		stage("End"){	
			steps {
				//prevent failure for first build
				sh 'exit 0'
			}
		}
	}		
}
